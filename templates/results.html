<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risultati per {{ artist_name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto p-4">
        <a href="/" class="text-green-400 hover:text-green-500 mb-4 inline-block">&larr; Nuova Ricerca</a>
        <h1 class="text-3xl font-bold mb-4">Risultati per <span class="text-green-400">{{ artist_name }}</span></h1>
        
        <form action="/download" method="post">
            <input type="hidden" name="artist_id" value="{{ artist_id }}">
            <div class="space-y-4">
                {% for album in albums %}
                <div class="bg-gray-800 p-4 rounded-lg flex items-center space-x-4">
                    <div class="flex-shrink-0">
                        {% if album.image_url %}
                        <img src="{{ album.image_url }}" alt="Copertina di {{ album.name }}" class="w-24 h-24 rounded">
                        {% endif %}
                    </div>
                    <div class="flex-grow">
                        <h2 class="text-xl font-semibold">{{ album.name }}</h2>
                        <a href="{{ album.url }}" target="_blank" class="text-sm text-gray-400 hover:text-green-400">Vedi su Spotify</a>
                        <button type="button" onclick="toggleTracks('{{ album.id }}', '{{ artist_id }}', this)" class="ml-4 bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-2 rounded">
                            Mostra Tracce
                        </button>
                    </div>
                    <div class="flex-shrink-0">
                        <input type="checkbox" name="selected_items" value="album-{{ album.id }}" class="form-checkbox h-6 w-6 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-500">
                    </div>
                </div>
                <div id="tracks-{{ album.id }}" class="hidden bg-gray-800 p-4 rounded-b-lg ml-8 space-y-2">
                    <!-- Le tracce verranno caricate qui -->
                </div>
                {% endfor %}
            </div>
            <div class="mt-6">
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 rounded p-3 text-lg font-bold">Avvia Download Selezionati</button>
            </div>
        </form>
    </div>

    <script>
        function toggleTracks(albumId, artistId, button) {
            const tracksDiv = document.getElementById(`tracks-${albumId}`);
            const isHidden = tracksDiv.classList.contains('hidden');

            if (isHidden) {
                // Carica le tracce se non sono gi√† state caricate
                if (tracksDiv.innerHTML.trim() === '<!-- Le tracce verranno caricate qui -->') {
                    tracksDiv.innerHTML = '<p class="text-gray-400">Caricamento tracce...</p>';
                    fetch(`/tracks/${albumId}?artist_id=${artistId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                tracksDiv.innerHTML = `<p class="text-red-400">${data.error}</p>`;
                                return;
                            }
                            tracksDiv.innerHTML = ''; // Pulisce il messaggio di caricamento
                            data.forEach(track => {
                                const trackEl = document.createElement('div');
                                trackEl.className = 'flex items-center justify-between';
                                trackEl.innerHTML = `
                                    <label for="track-${track.id}" class="flex-grow text-sm">${track.name}</label>
                                    <input type="checkbox" id="track-${track.id}" name="selected_items" value="track-${track.id}" data-url="${track.url}" data-name="${track.name}" class="form-checkbox h-5 w-5 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-500">
                                `;
                                tracksDiv.appendChild(trackEl);
                            });
                        })
                        .catch(() => {
                            tracksDiv.innerHTML = '<p class="text-red-400">Errore di rete nel caricare le tracce.</p>';
                        });
                }
                tracksDiv.classList.remove('hidden');
                button.textContent = 'Nascondi Tracce';
            } else {
                tracksDiv.classList.add('hidden');
                button.textContent = 'Mostra Tracce';
            }
        }
    </script>
</body>
</html>
